{% extends "admin/base_site.html" %}
{% load static %}

{% block extrastyle %}
<style>
:root {
    --dashboard-primary: #4361ee;
    --dashboard-success: #4cc9f0;
    --dashboard-warning: #f72585;
    --dashboard-info: #7209b7;
    --dashboard-dark: #3a0ca3;
}

.dashboard {
    background: #f8f9fa;
    min-height: 100vh;
    padding: 20px;
}

.dashboard-header {
    background: white;
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    margin-bottom: 25px;
    border-left: 5px solid var(--dashboard-primary);
}

.dashboard-title {
    color: var(--dashboard-primary);
    font-size: 2rem;
    font-weight: 700;
    margin: 0;
}

.dashboard-subtitle {
    color: #6c757d;
    font-size: 1.1rem;
    margin: 0;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-bottom: 25px;
}

.stat-card {
    background: white;
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    text-align: center;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border-top: 4px solid;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.stat-card.primary { border-top-color: var(--dashboard-primary); }
.stat-card.success { border-top-color: var(--dashboard-success); }
.stat-card.warning { border-top-color: var(--dashboard-warning); }
.stat-card.info { border-top-color: var(--dashboard-info); }
.stat-card.dark { border-top-color: var(--dashboard-dark); }

.stat-icon {
    font-size: 2.5rem;
    margin-bottom: 15px;
}

.stat-card.primary .stat-icon { color: var(--dashboard-primary); }
.stat-card.success .stat-icon { color: var(--dashboard-success); }
.stat-card.warning .stat-icon { color: var(--dashboard-warning); }
.stat-card.info .stat-icon { color: var(--dashboard-info); }
.stat-card.dark .stat-icon { color: var(--dashboard-dark); }

.stat-number {
    font-size: 2.2rem;
    font-weight: 700;
    margin: 10px 0;
    color: #2c3e50;
}

.stat-label {
    color: #7f8c8d;
    font-size: 1rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.charts-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 25px;
    margin-bottom: 25px;
}

.chart-card {
    background: white;
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.chart-title {
    font-size: 1.3rem;
    font-weight: 600;
    margin-bottom: 20px;
    color: #2c3e50;
    border-bottom: 2px solid #ecf0f1;
    padding-bottom: 10px;
}

.sales-chart {
    height: 300px;
    position: relative;
}

.quick-actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 25px;
}

.action-btn {
    background: white;
    border: 2px solid #e9ecef;
    padding: 20px;
    border-radius: 12px;
    text-align: center;
    text-decoration: none;
    color: #495057;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
}

.action-btn:hover {
    border-color: var(--dashboard-primary);
    color: var(--dashboard-primary);
    transform: translateY(-3px);
    text-decoration: none;
}

.action-icon {
    font-size: 2rem;
}

.tables-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 25px;
}

.table-card {
    background: white;
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.status-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
}

.status-pending { background: #fff3cd; color: #856404; }
.status-processing { background: #cce7ff; color: #004085; }
.status-shipped { background: #d1ecf1; color: #0c5460; }
.status-delivered { background: #d4edda; color: #155724; }
.status-cancelled { background: #f8d7da; color: #721c24; }

.stock-warning { background: #fff3cd; color: #856404; }
.stock-danger { background: #f8d7da; color: #721c24; }

/* Responsive */
@media (max-width: 1200px) {
    .charts-grid,
    .tables-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .dashboard {
        padding: 10px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard">
    <!-- Header -->
    <div class="dashboard-header">
        <h1 class="dashboard-title">üéÆ Dashboard MasivoTech</h1>
        <p class="dashboard-subtitle">Panel de control y an√°lisis de tu tienda gaming</p>
    </div>

    <!-- Estad√≠sticas Principales -->
    <div class="stats-grid">
        <div class="stat-card primary">
            <div class="stat-icon">üí∞</div>
            <div class="stat-number">${{ total_revenue|floatformat:2 }}</div>
            <div class="stat-label">Ingresos Totales</div>
        </div>
        
        <div class="stat-card success">
            <div class="stat-icon">üì¶</div>
            <div class="stat-number">{{ total_orders }}</div>
            <div class="stat-label">Total √ìrdenes</div>
        </div>
        
        <div class="stat-card info">
            <div class="stat-icon">üéØ</div>
            <div class="stat-number">{{ total_products }}</div>
            <div class="stat-label">Productos</div>
        </div>
        
        <div class="stat-card warning">
            <div class="stat-icon">‚ö†Ô∏è</div>
            <div class="stat-number">{{ low_stock_products }}</div>
            <div class="stat-label">Productos con Stock Bajo</div>
        </div>
        
        <div class="stat-card dark">
            <div class="stat-icon">‚ùå</div>
            <div class="stat-number">{{ out_of_stock_products }}</div>
            <div class="stat-label">Productos Agotados</div>
        </div>
    </div>

    <!-- Gr√°ficos y Tablas -->
    <div class="charts-grid">
        <!-- Gr√°fico de Ventas -->
        <div class="chart-card">
            <h3 class="chart-title">üìä Ventas de los √öltimos 7 D√≠as</h3>
            <div class="sales-chart">
                <canvas id="salesChart"></canvas>
            </div>
        </div>

        <!-- √ìrdenes por Estado -->
        <div class="chart-card">
            <h3 class="chart-title">üìà √ìrdenes por Estado</h3>
            <div style="height: 300px;">
                <canvas id="statusChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Acciones R√°pidas -->
    <div class="chart-card">
        <h3 class="chart-title">‚ö° Acciones R√°pidas</h3>
        <div class="quick-actions">
            <a href="/admin/marketplace/product/" class="action-btn">
                <div class="action-icon">‚ûï</div>
                <div>Agregar Producto</div>
            </a>
            <a href="/admin/marketplace/order/" class="action-btn">
                <div class="action-icon">üìã</div>
                <div>Ver √ìrdenes</div>
            </a>
            <a href="/admin/marketplace/product/?stock__lt=10" class="action-btn">
                <div class="action-icon">üìâ</div>
                <div>Stock Bajo</div>
            </a>
            <a href="/admin/marketplace/order/?status=pending" class="action-btn">
                <div class="action-icon">‚è≥</div>
                <div>√ìrdenes Pendientes</div>
            </a>
        </div>
    </div>

    <!-- Tablas de Informaci√≥n -->
    <div class="tables-grid">
        <!-- Productos M√°s Vendidos -->
        <div class="table-card">
            <h3 class="chart-title">üèÜ Productos M√°s Vendidos</h3>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Categor√≠a</th>
                            <th>Vendidos</th>
                            <th>Ingresos</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product in top_products %}
                        <tr>
                            <td>{{ product.product__name|truncatewords:3 }}</td>
                            <td>{{ product.product__category }}</td>
                            <td><strong>{{ product.total_sold }}</strong></td>
                            <td>${{ product.revenue|floatformat:2 }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="text-center text-muted">No hay datos de ventas</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Alertas de Stock -->
        <div class="table-card">
            <h3 class="chart-title">üîî Alertas de Inventario</h3>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Stock</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product in low_stock_products_list %}
                        <tr>
                            <td>{{ product.name }}</td>
                            <td><strong>{{ product.stock }}</strong></td>
                            <td>
                                {% if product.stock == 0 %}
                                <span class="status-badge stock-danger">AGOTADO</span>
                                {% else %}
                                <span class="status-badge stock-warning">STOCK BAJO</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="3" class="text-center text-muted">No hay alertas de stock</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extrajs %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Datos de ventas
    const salesData = {{ sales_json|safe }};
    
    // Gr√°fico de ventas
    const salesCtx = document.getElementById('salesChart').getContext('2d');
    new Chart(salesCtx, {
        type: 'bar',
        data: {
            labels: salesData.map(item => item.day_name),
            datasets: [{
                label: 'Ventas ($)',
                data: salesData.map(item => item.total),
                backgroundColor: 'rgba(67, 97, 238, 0.8)',
                borderColor: 'rgba(67, 97, 238, 1)',
                borderWidth: 2,
                borderRadius: 8,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `Ventas: $${context.raw.toFixed(2)}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value;
                        }
                    }
                }
            }
        }
    });

    // Gr√°fico de estados de √≥rdenes
    const statusData = {{ orders_by_status|safe }};
    const statusCtx = document.getElementById('statusChart').getContext('2d');
    
    const statusColors = {
        'pending': '#ffc107',
        'processing': '#17a2b8', 
        'shipped': '#20c997',
        'delivered': '#28a745',
        'cancelled': '#dc3545'
    };
    
    new Chart(statusCtx, {
        type: 'doughnut',
        data: {
            labels: statusData.map(item => {
                const statusMap = {
                    'pending': 'Pendiente',
                    'processing': 'Procesando',
                    'shipped': 'Enviado', 
                    'delivered': 'Entregado',
                    'cancelled': 'Cancelado'
                };
                return statusMap[item.status] || item.status;
            }),
            datasets: [{
                data: statusData.map(item => item.count),
                backgroundColor: statusData.map(item => statusColors[item.status] || '#6c757d'),
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
});
</script>
{% endblock %}